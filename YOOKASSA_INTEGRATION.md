# üí≥ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è YooKassa

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### 1. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ YooKassa**

#### API Endpoint:
```
POST /api/payments/yookassa/create
```

#### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: Bearer Token
- Content-Type: application/json

#### –ó–∞–ø—Ä–æ—Å:
```json
{
  "amount": 1000.00,
  "description": "–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ #12345",
  "userId": "user-uuid",
  "orderId": "order-uuid",
  "returnUrl": "https://yourapp.com/payments/success"
}
```

#### –û—Ç–≤–µ—Ç:
```json
{
  "paymentId": "payment-uuid",
  "yooKassaPaymentId": "2c68e1c4-0001-5000-9000-123456789abc",
  "confirmationUrl": "https://yoomoney.ru/checkout/payments/v2/...",
  "status": "pending"
}
```

### 2. **Webhook –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**

#### Endpoint:
```
POST /api/payments/yookassa/webhook
```

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ YooKassa:
1. –ó–∞–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç YooKassa
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
3. –£–∫–∞–∂–∏—Ç–µ URL: `https://your-domain.com/api/payments/yookassa/webhook`
4. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π:
- **payment.succeeded** - –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω ‚Üí —Å—Ç–∞—Ç—É—Å `completed` ‚Üí —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ MLM –∫–æ–º–∏—Å—Å–∏–π
- **payment.canceled** - –ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω ‚Üí —Å—Ç–∞—Ç—É—Å `failed`

### 3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ MLM-–∫–æ–º–∏—Å—Å–∏–π**

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. **–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞** –∫–ª–∏–µ–Ω—Ç–∞ (–¥–æ 3 —É—Ä–æ–≤–Ω–µ–π)
2. **–†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ–º–∏—Å—Å–∏–∏** –ø–æ —É—Ä–æ–≤–Ω—è–º:
   - 1 —É—Ä–æ–≤–µ–Ω—å: 10% –æ—Ç —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞
   - 2 —É—Ä–æ–≤–µ–Ω—å: 5% –æ—Ç —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞
   - 3 —É—Ä–æ–≤–µ–Ω—å: 3% –æ—Ç —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞
3. **–°–æ–∑–¥–∞—é—Ç—Å—è –±–æ–Ω—É—Å—ã** –¥–ª—è –º–∞—Å—Ç–µ—Ä–æ–≤ –≤ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Ü–µ–ø–æ—á–∫–µ
4. **–û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª–∏ –º–∞—Å—Ç–µ—Ä–æ–≤**:
   - `totalCommissions` - –æ–±—â–∞—è —Å—É–º–º–∞ –∫–æ–º–∏—Å—Å–∏–π
   - `availableBalance` - –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å

#### –õ–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:
- –ö–æ–º–∏—Å—Å–∏–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –º–∞—Å—Ç–µ—Ä–∞–º –≤ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Ü–µ–ø–æ—á–∫–µ
- –ï—Å–ª–∏ –≤ —Ü–µ–ø–æ—á–∫–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –Ω–µ-–º–∞—Å—Ç–µ—Ä, –æ–Ω –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è, –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É—Ä–æ–≤–Ω—é
- –ú–∞–∫—Å–∏–º—É–º 3 —É—Ä–æ–≤–Ω—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏

### 4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞**

#### API Endpoint:
```
GET /api/payments/yookassa/status/:paymentId
```

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –∏–∑ YooKassa.

## üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env):

```env
# YooKassa
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key
YOOKASSA_WEBHOOK_URL=https://your-domain.com/api/payments/yookassa/webhook
BACKEND_URL=https://your-domain.com

# Frontend
FRONTEND_URL=https://your-frontend.com
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ credentials:

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ [YooKassa](https://yookassa.ru/)
2. –°–æ–∑–¥–∞–π—Ç–µ –º–∞–≥–∞–∑–∏–Ω
3. –ü–æ–ª—É—á–∏—Ç–µ Shop ID –∏ Secret Key –≤ —Ä–∞–∑–¥–µ–ª–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

```typescript
// Frontend
const response = await fetch('/api/payments/yookassa/create', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    amount: 1000,
    description: '–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞',
    userId: currentUser.id,
    orderId: order.id
  })
});

const { confirmationUrl } = await response.json();
// –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ confirmationUrl
window.location.href = confirmationUrl;
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã YooKassa:
1. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ `returnUrl`
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä
3. –°–µ—Ä–≤–µ—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è MLM –∫–æ–º–∏—Å—Å–∏–∏

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```typescript
// Frontend - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞
const status = await fetch(`/api/payments/yookassa/status/${paymentId}`, {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Webhook Security:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
   - YooKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Request-Signature`
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–æ–¥ `verifyWebhookSignature()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

2. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**:
   - Webhook –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**:
   - –í—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∏–∑ YooKassa API
   - –ù–µ –¥–æ–≤–µ—Ä—è–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–º –∏–∑ webhook

## üìä MLM –ö–æ–º–∏—Å—Å–∏–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è:

```
–ö–ª–∏–µ–Ω—Ç ‚Üí –ú–∞—Å—Ç–µ—Ä 1 —É—Ä–æ–≤–Ω—è (10%) ‚Üí –ú–∞—Å—Ç–µ—Ä 2 —É—Ä–æ–≤–Ω—è (5%) ‚Üí –ú–∞—Å—Ç–µ—Ä 3 —É—Ä–æ–≤–Ω—è (3%)
```

### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞:

–ó–∞–∫–∞–∑ –Ω–∞ 10,000 ‚ÇΩ:
- –ú–∞—Å—Ç–µ—Ä 1 —É—Ä–æ–≤–Ω—è: 1,000 ‚ÇΩ
- –ú–∞—Å—Ç–µ—Ä 2 —É—Ä–æ–≤–Ω—è: 500 ‚ÇΩ
- –ú–∞—Å—Ç–µ—Ä 3 —É—Ä–æ–≤–Ω—è: 300 ‚ÇΩ
- **–ò—Ç–æ–≥–æ –∫–æ–º–∏—Å—Å–∏–π**: 1,800 ‚ÇΩ

### –ì–¥–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–º–∏—Å—Å–∏–∏:

1. **–í –ø—Ä–æ—Ñ–∏–ª–µ –º–∞—Å—Ç–µ—Ä–∞**: `/mlm` - —Ä–∞–∑–¥–µ–ª MLM
2. **–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**: —Ç–∞–±–ª–∏—Ü–∞ `bonuses`
3. **–í API**: `GET /api/mlm/stats/:userId`

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook:

```bash
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è webhook –ª–æ–∫–∞–ª—å–Ω–æ
ngrok http 3000

# –í YooKassa —É–∫–∞–∂–∏—Ç–µ webhook URL: https://your-ngrok-url.ngrok.io/api/payments/yookassa/webhook
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–π
- –û—à–∏–±–∫–∏

–°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞.

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º**: YooKassa –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ credentials –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
2. **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞**: –û–±—ã—á–Ω–æ 1 ‚ÇΩ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ YooKassa)
3. **–í–∞–ª—é—Ç–∞**: –¢–æ–ª—å–∫–æ RUB (—Ä–æ—Å—Å–∏–π—Å–∫–∏–µ —Ä—É–±–ª–∏)
4. **–¢–∞–π–º–∞—É—Ç**: –ü–ª–∞—Ç–µ–∂ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è - **–ì–û–¢–û–í–û**
2. ‚úÖ Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ - **–ì–û–¢–û–í–û**
3. ‚úÖ MLM –∫–æ–º–∏—Å—Å–∏–∏ - **–ì–û–¢–û–í–û**
4. ‚è≥ –í–æ–∑–≤—Ä–∞—Ç—ã —Å—Ä–µ–¥—Å—Ç–≤ (refunds)
5. ‚è≥ –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
6. ‚è≥ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ –∫–æ–º–∏—Å—Å–∏—è—Ö


